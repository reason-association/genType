# The cache key is built up of the following:
# We use a string that we can change to bust the cache
# The string "esy"
# The string for the OS
# The hash of the lock file
steps:
  - task: CacheBeta@0
    inputs:
      key: cache_string6 | esy | $(Agent.OS) | esy.lock/index.json
      path: $(STAGING_DIRECTORY)
      cacheHitVar: CACHE_RESTORED
    displayName: "[Cache2] esy packages"

  - task: CacheBeta@0
    inputs:
      key: npm | $(Agent.OS) | examples/commonjs-react-example/package-lock.json
      path: examples/commonjs-react-example/node_modules
    displayName: "[Cache2] npm commonjs-react-example"

  - task: CacheBeta@0
    inputs:
      key: npm | $(Agent.OS) | examples/flow-react-example/package-lock.json
      path: examples/flow-react-example/node_modules
    displayName: "[Cache2] npm flow-react-example"

  - task: CacheBeta@0
    inputs:
      key: npm | $(Agent.OS) | examples/typescript-react-example/package-lock.json
      path: examples/typescript-react-example/node_modules
    displayName: "[Cache2] npm typescript-react-example"

  - task: CacheBeta@0
    inputs:
      key: npm | $(Agent.OS) | examples/untyped-react-example/package-lock.json
      path: examples/untyped-react-example/node_modules
    displayName: "[Cache2] npm untyped-react-example"

  - bash: "mkdir -p $(ESY__CACHE_INSTALL_PATH)"
    condition: eq(variables.CACHE_RESTORED, 'true')
    displayName: "[Cache2][Restore] Create esy cache directory"

  - bash: cd $(ESY__CACHE_INSTALL_PATH) && tar xf $(STAGING_DIRECTORY_UNIX)/esy-cache.tgz
    displayName: "[Cache2][Restore] Unpack esy-cache.tgz"
    condition: eq(variables.CACHE_RESTORED, 'true')
